<template>
	<div class="myOrder" >	
		<div class="orderList" v-for="(item,index) in dataList" :key='index'>
			<div class="orderImg0">
				<img v-bind:src="item.src"/>
			</div>
			<span>{{item.lotyName}}</span>
			<div class="orderImg1" v-show="!item.status" @click="changeStatus(index,item.lotyId)"></div>
			<div class="orderImg2" v-show="item.status" @click="changeStatus(index,item.lotyId)"></div>
		</div>
	</div>
	
</template>
<script>
import card from '@/components/card'

export default {
  data () {
    return {
      motto: 'Hello World',
      userInfo: {},      
      dataList: [{
      'lotyId': 10,
      'lotyName': '双色球',
      'src': require('../../img/mine/orderImg2.png'),
      'status': false
      },
      {
      'lotyId': 11,
      'lotyName': '超级大乐透',
      'src': require('../../img/mine/orderImg3.png'),
      'status': false
      },
      {
      'lotyId': 12,
      'lotyName': '福彩3D',
      'src': require('../../img/mine/orderImg4.png'),
      'status': false
      },
      {
      'lotyId': 13,	
      'lotyName': '排列3',
      'src': require('../../img/mine/orderImg5.png'),
      'status': false
      },
      {
      'lotyId': 14,	
      'lotyName': '排列五',
      'src': require('../../img/mine/orderImg6.png'),
      'status': false
      },
      {
      'lotyId': 15,	
      'lotyName': '七星彩',
      'src': require('../../img/mine/orderImg7.png'),
      'status': false
      },
      {
      'lotyId': 16,	
      'lotyName': '七乐彩',
      'src': require('../../img/mine/orderImg1.png'),
      'status': false
      },
      
     ]
    }
  },

  components: {
    card
  },

  methods: {
    bindViewTap () {
      const url = '../logs/main'
      wx.navigateTo({ url })
    },
    getUserInfo () {
      // 调用登录接口
      wx.login({
        success: () => {
          wx.getUserInfo({
            success: (res) => {
              this.userInfo = res.userInfo
            }
          })
        }
      })
    },
    changeStatus (index,lotyId) {
      console.log('改变定阅状态');
      console.log(index);
      console.log(this.dataList[index].status);
      //把修改后的状态保存到本地
      if(this.dataList[index].status == false){
      	//新增订阅
        wx.login({
        success: (res) => {
        	console.log(res);
        	console.log(res.code);
        	wx.request({
            url: 'https://api.lottery666.com/miniapp/awardSubscribe',
            data: {
              code: res.code,
              opt: 'add',
              loty: lotyId
            },
            method: 'POST',
            success: function(res){
            	console.log(res.data.code);
            	//有请求数据表示已经被订阅过
            	if(res.data.code == 200){
                 console.log('订阅成功'); 
            	}        	
            }
         })
        }
      })
      	
      	//表示之前不再本地中需要新增
      	var value = wx.getStorageSync('order'); 
      	if (value && value.length > 0) {
      		value = JSON.parse(value);
      		value.push(this.dataList[index].lotyId);
      		value = JSON.stringify(value);
            wx.setStorage({
               key:"order",
               data: value
            }) 
      	}
      }else{
      	//删除订阅
      wx.login({
        success: (res) => {
        	console.log(res);
        	console.log(res.code);
        	wx.request({
            url: 'https://api.lottery666.com/miniapp/awardSubscribe',
            data: {
              code: res.code,
              opt: 'del',
              loty: lotyId
            },
            method: 'POST',
            success: function(res){
            	console.log(res.data.code);
            	//有请求数据表示已经被订阅过
            	if(res.data.code == 200){
                 console.log('删除成功'); 
            	}        	
            }
         })
        }
      })
      	
      	
      	//表示之前是在本地中需要删除
      	var value = wx.getStorageSync('order');
      	if(value && value.length > 0){
      	value = JSON.parse(value);
      	for(var i = 0; i < value.length; i++){
      		if(this.dataList[index].lotyId == value[i]){
      			value.splice(i,1);
      			break;
      		}
      	}
      	value = JSON.stringify(value);
      	wx.setStorage({
            key:"order",
            data: value
        }) 
      	}
      }
      this.dataList[index].status = !this.dataList[index].status;  
    }
  },
  created () {
    // 调用应用实例的方法获取全局数据
    this.getUserInfo();
    var value = wx.getStorageSync('order');
    console.log(value)
  },
   onLoad () {
   	//修改页面的标题
  	wx.setNavigationBarTitle({
      title: '我的订阅'
    })
   	console.log('获取信息')
    var value = wx.getStorageSync('order');
    console.log(value)
    if(value && value.length > 0){
    	value = JSON.parse(value);
    	console.log(value)
    	for(var i = 0; i < this.dataList.length; i++){
    		for(var j = 0; j < value.length; j++){
    			if(value[j] == this.dataList[i].lotyId){
    				this.dataList[i].status = true;
    			}
    		}
    	}
    } 
   }
}
</script>

<style scoped>
 page{
	height:100%;
}
.myOrder {
  width:100%;
  height: 100%;
  padding-bottom: 10px;
  font-size: 12px;
  background-color: #f1f0f5;
}

.orderList {
	height: 60px;
	width: 100%;
	box-sizing: border-box;
	padding: 14px 12px;
	border-bottom: 1px solid #e5e5e5;
	background-color: white;
}
.orderList:nth-last-child(1){
	border: none;
}
.orderList div,
.orderList span {
  float: left;	
}
.orderImg0 {
	margin-right: 8px;
}
.orderList span {
	line-height: 32px;
	color: black;
	font-size: 15px;
	font-weight: 600;
}
.orderImg0 img {
	display: block;
	height: 32px;
	width: 32px;
}
.orderImg1 {
	height: 29px;
	width: 56px;
	background-image: url(../../img/mine/order0.png);
	background-repeat: no-repeat;
	background-position: center;
	background-size: 100%;
	float: right !important;
}
.orderImg2 {
	height: 29px;
	width: 56px;
	background-image: url(../../img/mine/order1.png);
	background-repeat: no-repeat;
	background-position: center;
	background-size: 100%;
	float: right !important;
}
</style>
